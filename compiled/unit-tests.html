<!DOCTYPE html>
<html>
<head>
    <title>Unit Tests</title>

    <link rel="stylesheet" href="//cdn.jsdelivr.net/qunit/1.14.0/qunit.css" />

    <script type="text/javascript" src="//cdn.jsdelivr.net/g/qunit@1.14.0,underscorejs@1.6.0"></script>

    <script type="text/javascript" src="js/timeline.js"></script>


    <script type="text/javascript">

      function date_dict(d) {
        return {
          'milliseconds': d.getMilliseconds(),
          'seconds': d.getSeconds(),
          'minutes': d.getMinutes(),
          'hours': d.getHours(),
          'day': d.getDate(),
          'month': d.getMonth(), // 0-11 remember
          'year': d.getYear()
        }
      }

      function date_parts_match(a, b, parts) {
        a = date_dict(a);
        b = date_dict(b);
        for (var i = 0; i < parts.length; i++) {
          if (a[parts[i]] != b[parts[i]]) return false;
        };
        return true;
      }

      test("VCO.Date", function() {
        var refdate = new VCO.Date({year: 2000, month: 6, day: 21});
        var jsdate = new Date();
        throws(function() { refdate.isBefore(jsdate) }, "Don't allow comparison with JS Dates");
        jsdate = new VCO.Date(new Date());
        ok(refdate.isBefore(jsdate),"any new date should be after refdate");
        ok(jsdate.isAfter(refdate),"any new date should be after refdate");
      });

      module("timenav tests",{ // setup for tests that need TimelineConfig
        setup: function() {
          stop();
          this.timeline_config = new VCO.TimelineConfig('examples/marktwain.json',function(){
            start();
          });
        }
      });        

      test("TimelineConfig", function() {
        ok(this.timeline_config,"config loaded")
        var slides = this.timeline_config.slides;
        var sorted = true;
        for (var i = 0; i < slides.length - 1; i++) {
          var earlier = slides[i];
          var later = slides[i+1];
          sorted = sorted && (earlier.date.data.date_obj <= later.date.data.date_obj);
        };
        ok(sorted,"dates are sorted");
      });

      test("AxisHelper", function() {
        throws(function() { VCO.AxisHelper.floor(new Date(),'foobar'); },"bad scale throws error.")
          var d = new Date(1407440158306); // Thu Aug 07 2014 14:35:58 GMT-0500 (CDT)
          var floored = VCO.AxisHelper.floor(d, 'millisecond');
          ok(date_parts_match(d,floored,['year','month','date','hours','minutes','seconds','milliseconds']), 'millisecond rounding doesnt change others')
          equal(floored.getTime(), d.getTime(), 'rounds to millisecond')

          var floored = VCO.AxisHelper.floor(d, 'second');
          ok(date_parts_match(d,floored,['year','month','date','hours','minutes', 'seconds']), 'second rounding doesnt change others')
          equal(floored.getMilliseconds(),0,'seconds round to 0 millis ' + floored)

          var floored = VCO.AxisHelper.floor(d, 'minute');
          ok(date_parts_match(d,floored,['year','month','date','hours','minutes']), 'minute rounding doesnt change others')
          equal(floored.getMilliseconds(),0,'minutes round to 0 millis ' + floored)
          equal(floored.getSeconds(),0,'minutes round to 0 seconds ' + floored)

          var floored = VCO.AxisHelper.floor(d, 'hour');
          ok(date_parts_match(d,floored,['year','month','date','hours']), 'hour rounding doesnt change others')
          equal(floored.getMilliseconds(),0,'hours round to 0 millis ' + floored)
          equal(floored.getSeconds(),0,'hours round to 0 seconds ' + floored)
          equal(floored.getMinutes(),0,'hours round to 0 minutes ' + floored)

          var floored = VCO.AxisHelper.floor(d, 'day');
          ok(date_parts_match(d,floored,['year','month','date']), 'day rounding doesnt change others')
          equal(floored.getMilliseconds(),0,'days round to 0 millis ' + floored)
          equal(floored.getSeconds(),0,'days round to 0 seconds ' + floored)
          equal(floored.getMinutes(),0,'days round to 0 minutes ' + floored)
          equal(floored.getHours(),0,'days round to 0 hours ' + floored)

          var floored = VCO.AxisHelper.floor(d, 'month');
          ok(date_parts_match(d,floored,['year','month']), 'month rounding doesnt change others')
          equal(floored.getMilliseconds(),0,'months round to 0 millis ' + floored)
          equal(floored.getSeconds(),0,'months round to 0 seconds ' + floored)
          equal(floored.getMinutes(),0,'months round to 0 minutes ' + floored)
          equal(floored.getHours(),0,'months round to 0 hours ' + floored)
          equal(floored.getDate(),1,'months round to day 1 ' + floored)

          var floored = VCO.AxisHelper.floor(d, 'year');
          ok(date_parts_match(d,floored,['year']), 'year rounding doesnt change others')
          equal(floored.getMilliseconds(),0,'years round to 0 millis ' + floored)
          equal(floored.getSeconds(),0,'years round to 0 seconds ' + floored)
          equal(floored.getMinutes(),0,'years round to 0 minutes ' + floored)
          equal(floored.getHours(),0,'years round to 0 hours ' + floored)
          equal(floored.getDate(),1,'years round to day 1 ' + floored)
          equal(floored.getMonth(),0,'years round to month 0 ' + floored)

          var floored = VCO.AxisHelper.floor(d, 'decade');
          equal(floored.getYear(),110, "decade should round to 2010 " + floored)

          var floored = VCO.AxisHelper.floor(d, 'century');
          equal(floored.getYear(),100, "century should round to 2000 " + floored)

          var floored = VCO.AxisHelper.floor(d, 'millennium');
          equal(floored.getYear(),100, "Should round to 2000 " + floored)

      });

      test("TimeScale", function() {
        ok(this.timeline_config,"test data loaded");
        var timescale = new VCO.TimeScale(this.timeline_config.slides);
        equal(timescale.getMinorScale(),'year',"timescale should be years");
        ok(timescale.getMajorTicks().ticks.length > 0,"should be some major ticks")
        ok(timescale.getMinorTicks().ticks.length > 0,"should be some minor ticks")
      });
    </script>
</head>
<body>
    <div id="qunit"></div>
</body>
</html>